<!-- Formulaire de connexion -->
<form id="login-form">
    <h2>Connexion</h2>
    <label for="login-email">Email:</label>
    <input type="email" id="login-email" required>
    <label for="login-password">Mot de passe:</label>
    <input type="password" id="login-password" required>
    <button type="submit">Se connecter</button>
</form>

<!-- Formulaire d'inscription -->
<form id="register-form">
    <h2>Inscription</h2>
    <label for="register-email">Email:</label>    
    <input type="email" id="register-email" required>
    <label for="pseudo">Pseudo:</label>
    <input type="text" id="pseudo" required>
    <label for="register-password">Mot de passe:</label>
    <input type="password" id="register-password" required>
    <button type="submit">S'inscrire</button>
</form>
<div id="messages"></div>

<div id="sendMsg">
    <input type="text" id="msgTxt" placeholder="ENTER YOUR MSG...">
    <input type="submit" id="msgBtn" value="send" onclick="module.sendMsg()">
    <script>
        // Listen for Enter key press event
        document.getElementById('msgTxt').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                module.sendMsg();
            }
        });
    </script>
</div>

<script>
    module = {};
    module.promptUsername = function promptUsername() {
        user = prompt('PLEASE ENTER YOUR NAME');
        sessionStorage.setItem('user', user);
    }
</script>
<script src="js/firebaseConfig.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, remove, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
        // Add your Firebase configuration here
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // variables
    var msgTxt = document.getElementById('msgTxt');
    var user;

    if (sessionStorage.getItem('user')) {
        user = sessionStorage.getItem('user');
    } else {
        module.promptUsername();
    }

    // TO SEND MESSAGES
    module.sendMsg = function sendMsg(conversationId) {
        var msg = msgTxt.value;
        if (msg != '') {
            set(ref(db, "conversations/" + conversationId + "/messages"), {
                user: user,
                msg: msg
            });
            msgTxt.value = '';
        }
    }

    // TO CONNECT USER
    document.getElementById('register-form').addEventListener('submit', function(event) {
        event.preventDefault();
        var email = document.getElementById('register-email').value;
        var password = document.getElementById('register-password').value;
        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                // User created successfully
                const user = userCredential.user;
                sessionStorage.setItem('user', user.email);
                alert("User created successfully with email: " + user.email);
            })
            .catch((error) => {
                alert("Error creating user: " + error.message);
            });
    });

    // TO RECEIVE MSG
    onChildAdded(ref(db, "conversations/{validConversationId}/messages"), (data) => {
        var messageElement = document.createElement('div');
        var textElement = document.createElement('div');
        var buttonElement = document.createElement('button');

        if (data.val().user == user) {
            messageElement.setAttribute('style', 'justify-content:end');
            messageElement.setAttribute('class', 'outer');
            messageElement.setAttribute('id', data.key);
            textElement.setAttribute('id', 'inner');
            textElement.setAttribute('class', 'me');
            textElement.textContent = "you : " + data.val().msg;
            buttonElement.setAttribute('id', 'dltMsg');
            buttonElement.setAttribute('onclick', "module.dltMsg('" + data.key + "')");
            buttonElement.textContent = 'ðŸ—‘ï¸';
            textElement.appendChild(buttonElement);
        } else {
            messageElement.setAttribute('class', 'outer');
            messageElement.setAttribute('id', data.key);
            textElement.setAttribute('id', 'inner');
            textElement.setAttribute('class', 'notMe');
            textElement.textContent = data.val().user + " : " + data.val().msg;
        }

        messageElement.appendChild(textElement);
        messages.appendChild(messageElement);
    });

    // TO DELETE MSG
    module.dltMsg = function dltMsg(key) {
        const user = getAuth().currentUser;
        if (uid === user.uid) {
            remove(ref(db, "messages/" + key));
        } else {
            console.log("User not authenticated.");
        }
    }

    // WHEN MSG IS DELETED
    onChildRemoved(ref(db, "messages"), (data) => {
        var msgBox = document.getElementById(data.key);
        messages.removeChild(msgBox);
    })
</script>
<script src="js/script.js"></script>
